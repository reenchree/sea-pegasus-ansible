---
# Playbook to completely tear down Pterodactyl VM
#
# This playbook:
# 1. Destroys and undefines the VM
# 2. Removes all disk files and cloud-init configs
# 3. Cleans up VM-related resources
#
# Usage:
#   ansible-playbook -i inventory.yml playbooks/pterodactyl-teardown.yml

- name: Tear Down Pterodactyl VM
  hosts: pegasus
  become: true
  gather_facts: false

  vars:
    vm_config: "{{ hostvars['pterodactyl'] }}"

  tasks:
    - name: Check if VM exists
      community.libvirt.virt:
        command: list_vms
      register: existing_vms

    - name: Set VM exists fact
      ansible.builtin.set_fact:
        vm_exists: "{{ vm_config.vm_name in existing_vms.list_vms }}"

    - name: Destroy running VM
      community.libvirt.virt:
        name: "{{ vm_config.vm_name }}"
        state: destroyed
      when: vm_exists
      ignore_errors: true

    - name: Undefine VM and remove storage
      ansible.builtin.command:
        cmd: >
          virsh undefine {{ vm_config.vm_name }} --remove-all-storage
      when: vm_exists
      register: undefine_result
      changed_when: "'Domain' in undefine_result.stdout"
      failed_when: false

    - name: Remove cloud-init configuration files
      ansible.builtin.file:
        path: "{{ vm_config.vm_disk_path }}/{{ vm_config.vm_name }}-{{ item }}"
        state: absent
      loop:
        - meta-data
        - user-data
        - network-config
      when: vm_exists

    - name: Remove VM disk if it still exists
      ansible.builtin.file:
        path: "{{ vm_config.vm_disk_path }}/{{ vm_config.vm_name }}.qcow2"
        state: absent

    - name: Display teardown status
      ansible.builtin.debug:
        msg:
          - "Pterodactyl VM teardown complete!"
          - "VM '{{ vm_config.vm_name }}' has been removed"
          - "Disk files cleaned up from {{ vm_config.vm_disk_path }}"
          - ""
          - "To recreate the VM, run:"
          - "  ansible-playbook -i inventory.yml playbooks/pterodactyl.yml"
